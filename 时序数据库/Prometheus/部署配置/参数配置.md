# Prometheus 参数配置

Prometheus 配置方式有两种：命令行，用来配置不可变命令参数，主要是 Prometheus 运行参数，比如数据存储位置、配置文件，用来配置 Prometheus 应用参数，比如数据采集，报警对接。不重启进程配置生效方式也有两种：

- 对进程发送信号 SIGHUP，`kill -HUP <pid>`。
- HTTP POST 请求，需要开启--web.enable-lifecycle 选项 `curl -X POST http://192.168.66.112:9091/-/reload`。

# 配置文件基础

我们可以通过参数 --config.file 来指定配置文件，配置文件格式为 YAML。配置文件的基础构成如下：

```yml
＃全局配置
global:
＃规则配置主要是配置报警规则
rule_files:
＃抓取配置，主要配置抓取客户端相关
scrape_configs:
＃报警配置
alerting:
＃用于远程存储写配置
remote_write:
＃用于远程读配置
remote_read:
```

配置文件中通用字段值格式：`<boolean>`: 布尔类型值为 true 和 false、`<scheme>`: 协议方式包含 http 和 https。我们可以打开默认的配置文件 prometheus.yml 看下里面的内容：

```yaml
/etc/prometheus $ cat prometheus.yml
# my global config
global:
  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
    - targets: ['localhost:9090']
```

Prometheus 默认的配置文件分为四大块：

- global 块：Prometheus 的全局配置，比如 scrape_interval 表示 Prometheus 多久抓取一次数据，evaluation_interval 表示多久检测一次告警规则。

- alerting 块：关于 Alertmanager 的配置。

- rule_files 块：告警规则。

- scrape_config 块：这里定义了 Prometheus 要抓取的目标，我们可以看到默认已经配置了一个名称为 prometheus 的 job，这是因为 Prometheus 在启动的时候也会通过 HTTP 接口暴露自身的指标数据，这就相当于 Prometheus 自己监控自己，虽然这在真正使用 Prometheus 时没啥用处，但是我们可以通过这个例子来学习如何使用 Prometheus；可以访问 http://localhost:9090/metrics 查看 Prometheus 暴露了哪些指标。

## global 字段

```sh
# scrape_interval，全局默认的数据拉取间隔
[ scrape_interval: <duration> | default = 1m ]

# scrape_timeout，全局默认的单次数据拉取超时，当报context deadline exceeded错误时需要在特定的job下配置该字段
[ scrape_timeout: <duration> | default = 10s ]

# evaluation_interval，全局默认的规则(主要是报警规则)拉取间隔
[ evaluation_interval: <duration> | default = 1m ]

# external_labels，该服务端在与其他系统对接所携带的标签
[ <labelname>: <labelvalue> ... ]
```

## rule_files

Prometheus 支持两种类型的规则：记录规则和警报规则。要在 Prometheus 中包含规则，请创建一个包含必要规则语句的文件，并让 Prometheus 通过配置中的 rule_files 字段加载规则文件。

# Alerting rules

告警规则语法如下：

```yml
# The name of the alert. Must be a valid metric name.
alert: <string>

# The PromQL expression to evaluate. Every evaluation cycle this is
# evaluated at the current time, and all resultant time series become
# pending/firing alerts.
expr: <string>

# Alerts are considered firing once they have been returned for this long.
# Alerts which have not yet fired for long enough are considered pending.
[ for: <duration> | default = 0s ]

# Labels to add or overwrite for each alert.
labels:
  [ <labelname>: <tmpl_string> ]

# Annotations to add to each alert.
annotations:
  [ <labelname>: <tmpl_string> ]
```

告警规则的例子为：

```yml
groups:
  - name: example
    rules:
      - alert: HighErrorRate
        expr: job:request_latency_seconds:mean5m{job="myjob"} > 0.5
        for: 10m
        labels:
          severity: page
        annotations:
          summary: High request latency
```
