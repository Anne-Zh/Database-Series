# 数据模型与类型

Prometheus 从根本上存储的所有数据都是时间序列: 具有时间戳的数据流只属于单个度量指标和该度量指标下的多个标签维度。Prometheus 采用了单值模型， 数据模型的核心概念是 metric,labels 和 samples；其格式为：`<metric name>{<label name>=<label value>, …}`。一条 Prometheus 数据由一个指标名称（metric）和 N 个标签（label，N >= 0）组成的，比如下面这个例子：

```sh
promhttp_metric_handler_requests_total{code="200",instance="192.168.0.107:9090",job="prometheus"} 106
```

metric 的命名具有业务含义，比如 http_request_total，指标的类型分为：Counter， Gauge，Historgram，Summary。labels 用于表示维度，samples 由时间戳和数值组成。Prometheus 会自动生成 target 和 instances 作为标签。这种数据模型和 OpenTSDB 的数据模型是比较类似的，详细的信息可以参考官网文档 [Data model](https://prometheus.io/docs/concepts/data_model/)。另外，关于指标和标签的命名，官网有一些指导性的建议，可以参考 [Metric and label naming](https://prometheus.io/docs/practices/naming/) 。

除了存储时间序列数据外，Prometheus 也可以利用查询表达式存储 5 分钟的返回结果中的时间序列数据。

# Metrics Name & Label

每条时间序列是由唯一的指标名称和一组标签 (key=value)的形式组成。指标名称 一般是给监测对像起一名字，例如 `http_requests_total` 这样，它有一些命名规则，可以包字母数字之类的的。通常是以 `应用名称开头_监测对像_数值类型_单位` 这样。

- push_total

- userlogin_mysql_duration_seconds

- app_memory_usage_bytes

标签 就是对一条时间序列不同维度的识别了，例如 一个 http 请求用的是 POST 还是 GET，它的 endpoint 是什么，这时候就要用标签去标记了。最终形成的标识便是这样了

```yaml
http_requests_total{method="POST",endpoint="/api/tracks"}
```

针对 http_requests_total 这个 metrics name 无论是增加标签还是删除标签都会形成一条新的时间序列。查询语句就可以跟据上面标签的组合来查询聚合结果了。如果以传统数据库的理解来看这条语句，则可以考虑 http_requests_total 是表名，标签是字段，而 timestamp 是主键，还有一个 float64 字段是值了。

# 数据类型

## Counter | 计数

Counter 用于累计值，例如记录请求次数、任务完成数、错误发生次数等，该值一直增加，不会减少，重启进程后，会被重置。譬如：

```sh
http_response_total{method="GET",endpoint="/api/tracks"} 100
```

## Gauge | 常规数值

Gauge 常规数值，例如温度变化、内存使用变化，该值可变大可变小，重启进程后，该值会被重置。

```yaml
memory_usage_bytes{host="master-01"} 100 < 抓取值
memory_usage_bytes{host="master-01"} 30
memory_usage_bytes{host="master-01"} 50
memory_usage_bytes{host="master-01"} 80 < 抓取值
```

## Histogram | 柱状图

Histogram 可以理解为柱状图的意思，常用于跟踪事件发生的规模，例如：请求耗时、响应大小。它特别之处是可以对记录的内容进行分组，提供 count 和 sum 全部值的功能。

## Summary | 求和

Summary 和 Histogram 十分相似，常用于跟踪事件发生的规模，例如：请求耗时、响应大小。同样提供 count 和 sum 全部值的功能。不同之处是，它提供了一个 quantiles 的功能，可以按百分比划分跟踪的结果。例如：quantile 取值 0.95，表示取采样值里面的 95% 数据。

# 链接

- https://mp.weixin.qq.com/s/beusaP2f3mOMIlEETBhtjg
