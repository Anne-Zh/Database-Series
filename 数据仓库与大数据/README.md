# 数据仓库与大数据

数据仓库（Data Warehouse）,可简写为 DW 或 DWH；数据仓库，是为了企业所有级别的决策制定计划过程，提供所有类型数据类型的战略集合。它出于分析性报告和决策支持的目的而创建。为需要业务智能的企业，为需要指导业务流程改进、监视时间，成本，质量以及控制等；

数仓构建包括模型定义和预计算两部分，数据工程师根据业务分析需要，使用星型或雪花模型设计数据仓库结构，利用数据仓库中间件完成模型构建和更新。本章我们主要讨论数据模型与模型定义的相关内容，而实际的模型构建与计算则在 OLAP 一章中讨论。

# 数据栈

我们发现，公司处理数据的过程主要分为四个主要阶段，这些阶段与每个阶段数据的外化使用密切相关。

![数据阶段](https://s2.ax1x.com/2019/11/01/K7V7rj.png)

上图中的每个垂直阶段都是一个相对的平衡点，可根据您的资源，规模和组织中数据的重要性来进行操作。例如，一个有 20 个人的具有典型数据需求的团队可能会直接在 Source 级别上很好地工作，并且在他们开始感觉到增长的痛苦之前，不希望进入 Lake 阶段。但是，随着该公司的规模超过 200 名员工，并且他们的数据需求不断增长，将其推进到 Mart 的整个过程将具有不可估量的价值，甚至可能是至关重要的。

## Sources

当您开始使用数据时，可能只有几个感兴趣的来源。 早期的两个常见来源是 Google Analytics（分析）和产品所使用的 PostgreSQL 或 MySQL 数据库中的应用程序数据。如果您公司中只有少数几个人需要使用这些资源，则可以将其设置为具有直接访问权限；他们直接直接处理数据会更简单，更灵活。

在此早期阶段，您将受益于使用 BI 产品，该产品可让您在需要时编写 SQL，因为您的数据很可能是出于交易目的而构造的，并且通常需要某些复杂查询的全部功能。

## Lake

当您开始依赖更多的数据源，并且更频繁地需要合并数据时，您将需要构建一个 Data Lake，这是所有数据以统一格式一起存在的地方。尤其是当您需要使用 Salesforce，HubSpot，Jira 和 Zendesk 等应用程序中的数据时，您将需要为这些数据创建一个主目录，以便可以使用单个 SQL 语法一起访问所有数据，而不是许多不同的 API。

如果这是大量数据（每天> 100GB），则需要将其存储在 S3 中。但是对于大多数使用情况，您将需要将其存储在数据仓库引擎中，例如 Redshift，Panoply，Snowflake 或 Big Query。在这里，您的数据仍处于其原始事务或事件结构中，并且有时会需要一些凌乱的 SQL，这仍然会限制谁可以实际使用数据。但是，Data Lake 将具有更高的性能，可以使用一种 SQL 语法在一个地方使用，并且可以为下一个重要阶段做好准备。

## Warehouse (single source of truth)

在 Lake 阶段，当您吸引更多人使用数据时，您必须向他们解释每种模式的奇特之处，哪些数据在哪里以及需要在每个表中进行过滤的特殊条件。这变得很繁重，并且会导致您经常遇到数据的完整性问题。最终，您将需要开始将数据整理到一个单一的真实来源中。从历史上看，这个阶段（创建数据仓库）一直是一场噩梦，并且有许多著作着眼于如何最好地建模数据以进行分析处理。 但是，如今这并不困难了，它不仅使您不必向新团队成员解释所有架构的怪异，而且还可以节省您重复，编辑和维护自己的混乱查询的时间。

- 使用您自己的文件或使用 dbt 之类的出色框架，以 SQL 中新的视图模式进行建模。不要使用专有的第三方建模语言；最好用 SQL 完成。它功能强大，性能卓越，与供应商无关，并且您的团队已经知道这一点。

- 不要阅读过多的有关 Inman 或 Kimball 等传奇人物关于尺寸建模的书籍，以免过分思考您的建模。那里的大多数书籍都有几十年的历史了，正如我上文所述，最佳实践是基于完全不同的技术考量。

- 您的分析模型现在应该仅是原始事务模式的简化，过滤，最小化，描述性命名的纯净版本。就像您的公司没有在许多不同的详细 SaaS 应用程序和具有奇特情况和复杂集成的事务性数据库上运行一样，创建它们。而是在单个理想的，完美清洁的整体应用程序上运行。这个理想的应用程序具有干净的操作架构，随着它成为您公司的真理之源，它会慢慢发展。

## Marts

当您拥有干净的数据并在其上拥有良好的 BI 产品时，您应该开始注意到公司中的许多人都能够回答他们自己的问题，并且越来越多的人参与其中。这是个好消息：您的公司越来越了解信息，业务和生产力结果也应显示出来。 您也不必担心完整性问题，因为您已经对数据进行了建模，并且不断将其维护为干净，清晰的事实来源。

最终，您将在该事实来源中拥有数百张表，并且当用户尝试查找与其相关的数据时，他们将不知所措。您可能还会发现，根据团队，部门或用例的不同，不同的人希望使用以不同方式构造的同一数据。 由于这些原因，您将要开始推出 Data Marts。

数据集市是团队或调查主题的更小更具体的真理来源。 例如，销售团队可能只需要主仓库中的 12 个左右的表，而营销团队可能需要 20 个表。其中一些是相同的，但有些不同。创建这些数据集市的方法与仓库相同。只需使用视图的 SQL（无论是否实现）指向真相的源来创建新的架构。

# 数仓特性

数据仓库能够极大地辅助商业智能决策，譬如年度销售目标的制定，需要根据以往的历史报表进行决策，不能随便制定。某电商平台某品牌的手机，在过去 5 年主要的的购买人群的年龄在什么年龄段，在那个季节购买量人多，这样就可以根据这个特点为目标人群设定他们主要的需求和动态分配产生的生产量，和仓库的库存。

## 面向主题

与传统的数据库不一样，数据仓库是面向主题的，那什么是主题呢？首页主题是一个较高乘次的概念，是较高层次上企业信息系统中的数据综合，归类并进行分析的对象。在逻辑意义上，他是对企业中某一个宏观分析领域所涉及的分析对象。

就是用户用数据仓库进行决策所关心的重点方面，一个主题通常与多个操作信息型系统有关，而操作型数据库的数据组织面向事务处理任务，各个任务之间是相互隔离的。

## 数据集成

数据仓库的数据是从原来的分散的数据库数据（mysql 等关系型数据库）抽取出来的。操作型数据库与 DSS（决策支持系统）分析型数据库差别甚大。第一，数据仓库的每一个主题所对应的源数据在所有的各个分散的数据库中，有许多重复和不一样的地方，且来源于不同的联机系统的数据都和不同的应用逻辑捆绑在一起；第二，数据仓库中的综合数据不能从原来有的数据库系统直接得到。因此子在数据进入数据仓库之前，必然要经过统一与综合，这一步是数据仓库建设中最关键，最复杂的一步，所要完成的工作有：

- 要统计源数据中所有矛盾之处，如字段的同名异议、异名同义、单位不统一，字长不统一等。
- 进行数据的综合和计算。数据仓库中的数据综合工作可以在原有数据库抽取数据时生成，但许多是在数据仓库内部生成的，即进入数据仓库以后进行综合生成的。

## 时序数据

数据仓库的数据是随着时间的变化而变化的，数据仓库中的数据不可更新是针对应用来说的，也就是说，数据仓库的用户进行分析处理是不进行数据更新操作的。但并不是说，在从数据集成输入数据仓库开始到最后被删除的整个生存周期中，所有的数据仓库数据都是永远不变的。

数据仓库的数据是随着时间变化而变化的，这是数据仓库的特征之一。这一特征主要有以下三个表现：

- 数据仓库随着时间变化不断增加新的数据内容。数据仓库系统必须不断捕捉 OLTP 数据库中变化的数据，追加到数据仓库当中去，也就是要不断的生成 OLTP 数据库的快照，经统一集成增加到数据仓库中去；但对于确实不在变化的数据库快照，如果捕捉到新的变化数据，则只生成一个新的数据库快照增加进去，而不会对原有的数据库快照进行修改。

- 数据库随着时间变化不断删去旧的数据内容 。数据仓库内的数据也有存储期限，一旦过了这一期限，过期数据就要被删除。只是数据库内的数据时限要远远的长于操作型环境中的数据时限。在操作型环境中一般只保存有 60~90 天的数据，而在数据仓库中则要需要保存较长时限的数据（例如：5~10 年），以适应 DSS 进行趋势分析的要求。

- 数据仓库中包含有大量的综合数据，这些综合数据中很多跟时间有关，如数据经常按照时间段进行综合，或隔一定的时间片进行抽样等等。这些数据要随着时间的变化不断地进行从新综合。因此数据仓库的数据特征都包含时间项，以标明数据的历史时期。

## 不可变性

数据仓库的数据主要提供企业决策分析之用，所涉及的数据操作主要是数据查询，一般情况下并不进行修改操作。数据仓库的数据反映的是一段相当长的时间内历史数据的内容，是不同时点的数据库快照的集合， 以及基于这些快照进行统计、综合和重组的导出数据，而不是联机处理的数据。数据库中进行联机处理的书库进过集成输入到数据仓库中，一旦数据仓库存放的数据已经超过数据仓库的数据存储期限，这些数据将从当前的数据仓库中删去。

因为数据仓库只进行数据查询操作，所以数据仓库当中的系统要比数据库中的系统要简单的多。数据库管理系统中许多技术难点，如完整性保护、并发控制等等，在数据仓库的管理中几乎可以省去。但是由于数据仓库的查询数据量往往很大，所以就对数据查询提出了更高的要求，他要求采用各种复杂的索引技术；同时数据仓库面向的是商业企业的高层管理层，他们会对数据查询的界面友好性和数据表示提出更高的要求。
